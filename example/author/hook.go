package author

import (
	"context"
	"github.com/jackc/pgconn"
	"github.com/jackc/pgx/v4"
)

// QuerierHook provides a before and after hook for executing all queries
// generated by sqld.
type QuerierHook interface {
	// BeforeQuery runs when a Querier is first invoked.
	//
	// BeforeQuery may modify the SQL query that's executed by replacing the value
	// of the string pointer in BeforeHookParams.SQL.
	BeforeQuery(ctx context.Context, params BeforeHookParams) context.Context

	// AfterQuery runs immediately after the Querier receives the results from
	// executing a query but before the rows are scanned.
	//
	// AfterQuery may modify the query error by replacing the value of the error
	// pointer in AfterHookParams.QueryErr.
	AfterQuery(ctx context.Context, params AfterHookParams)
}

type BeforeHookParams struct {
	// The name of the query as written in the SQL source file.
	QueryName string
	// The SQL query as written in the SQL source file.
	SQL *string
	// True if this query is a batched query.
	IsBatch bool
}

type AfterHookParams struct {
	// The name of the query as written in the SQL source file.
	QueryName string
	// The SQL query as written in the SQL source file.
	SQL string
	// True if this query is a batched query.
	IsBatch bool
	// The resulting rows of executing a SELECT statement query. Nil for
	// modification queries like UPDATE, INSERT, and DELETE. You must not retain
	// a reference to rows; It will be invalid after sqld scans the first row.
	Rows pgx.Rows
	// The command tag for the query. Always set if the query succeeded.
	CommandTag pgconn.CommandTag
	// The result query error, if any. The hook may wrap or ignore errors by
	// overwriting the pointer value.
	QueryErr *error
}

type nopHook struct{}

var defaultNopHook = nopHook{}

func NewNopHook() QuerierHook                                                         { return defaultNopHook }
func (n nopHook) BeforeQuery(ctx context.Context, _ BeforeHookParams) context.Context { return ctx }
func (n nopHook) AfterQuery(context.Context, AfterHookParams)                         {}
